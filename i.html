<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BMS Hype – Pro Financial Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
--bg:#f4f6fa;
--card:#ffffff;
--border:#e6eaf2;
--text:#111827;
--muted:#6b7280;
--green:#16a34a;
--red:#dc2626;
--yellow:#f59e0b;
--primary:#111827;
--radius:14px;
--shadow:0 20px 50px rgba(15,23,42,.08);
}

*{box-sizing:border-box;font-family:"Inter",sans-serif}

body{
margin:0;
background:var(--bg);
color:var(--text);
}

.container{
max-width:1300px;
margin:70px auto 40px;
padding:0 20px;
}

/* HEADER */

.header{
display:flex;
justify-content:space-between;
align-items:center;
flex-wrap:wrap;
margin-bottom:20px;
gap:15px;
}

.title{
font-size:22px;
font-weight:800;
letter-spacing:.05em;
}

.meta{
font-size:12px;
color:var(--muted);
margin-top:4px;
}

.controls{
display:flex;
gap:8px;
flex-wrap:wrap;
}

input,button{
height:34px;
padding:0 14px;
border-radius:8px;
border:1px solid var(--border);
font-size:12px;
font-weight:600;
background:#fff;
}

button{
cursor:pointer;
transition:.2s ease;
}

button:hover{
background:#f3f4f6;
}

button.primary{
background:var(--primary);
color:#fff;
border:none;
}

.card{
background:var(--card);
border-radius:var(--radius);
box-shadow:var(--shadow);
overflow:auto;
}

/* TABLE */

table{
width:100%;
border-collapse:collapse;
font-variant-numeric:tabular-nums;
}

thead th{
font-size:11px;
text-transform:uppercase;
letter-spacing:.08em;
padding:14px 10px;
border-bottom:1px solid var(--border);
cursor:pointer;
}

tbody td{
padding:12px 10px;
font-size:13px;
border-bottom:1px solid #f1f5f9;
}

tbody tr{
transition:.15s ease;
}

tbody tr:hover{
background:#f9fafb;
}

.rank-col{
font-weight:700;
color:#6b7280;
}

.up{color:var(--green);font-size:11px;font-weight:600;}
.down{color:var(--red);font-size:11px;font-weight:600;}
.flat{color:#9ca3af;font-size:11px;}

/* IMPACT BAR */

.impact-wrap{
display:flex;
flex-direction:column;
align-items:flex-end;
gap:4px;
}

.impact-bar{
width:90px;
height:6px;
background:#e5e7eb;
border-radius:4px;
overflow:hidden;
}

.impact-bar div{
height:100%;
background:linear-gradient(90deg,#111827,#374151);
transition:width .4s ease;
}

/* LOAD MORE */

.load-more{
display:block;
margin:20px auto;
height:36px;
padding:0 24px;
border-radius:8px;
border:1px solid var(--border);
background:#fff;
font-weight:600;
cursor:pointer;
}

/* TOAST */

.toast{
position:fixed;
bottom:30px;
right:30px;
background:#111827;
color:#fff;
padding:12px 20px;
border-radius:8px;
opacity:0;
transform:translateY(20px);
transition:.3s ease;
}

.toast.show{
opacity:1;
transform:translateY(0);
}

@media(max-width:950px){
thead th,tbody td{font-size:11px;padding:8px}
}

</style>
</head>
<body>

<div class="container">

<div class="header">
<div>
<div class="title">BMS Hype – Pro Dashboard</div>
<div class="meta" id="metaInfo"></div>
</div>

<div class="controls">
<input type="date" id="datePicker">
<input type="text" id="searchInput" placeholder="Search movie">
<button onclick="copyTweet()">Copy</button>
<button class="primary" onclick="tweetNow()">Tweet</button>
</div>
</div>

<div class="card">
<table>
<thead>
<tr>
<th>#</th>
<th onclick="sortBy('name')">Movie</th>
<th onclick="sortBy('points')">Hype</th>
<th onclick="sortBy('cities')">Cities</th>
<th>Rank1</th>
<th>#2</th>
<th>#3</th>
<th onclick="sortBy('domination')">Impact</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<button class="load-more" id="loadMoreBtn" onclick="loadMore()">Load More</button>

</div>

<div class="toast" id="toast"></div>

<script>

let allMovies=[]
let previousMap={}
let visibleCount=30
let currentSort="points"
let sortDirection="desc"

const baseURL="https://cdn.jsdelivr.net/gh/unknownman2024/bms-hype@main/Data/"

/* LOAD DATA */

async function loadData(date){
const year=date.split("-")[0]
const res=await fetch(`${baseURL}${year}/Rankings_${date}.json`)
const data=await res.json()

metaInfo.innerHTML=`Date: ${data.date} | Updated: ${data.last_updated} | Cities: ${data.success_cities}`

await loadPrevious(date)
processData(data)
render()
}

async function loadPrevious(date){
let d=new Date(date)
d.setDate(d.getDate()-1)
let prev=d.toISOString().split("T")[0]

try{
const year=prev.split("-")[0]
const res=await fetch(`${baseURL}${year}/Rankings_${prev}.json`)
const data=await res.json()

let map={}
for(const city in data.rankings){
for(const key in data.rankings[city]){
const movie=data.rankings[city][key]
const rank=parseInt(key.replace("rank",""))
const points=9-rank
if(!map[movie]) map[movie]=0
map[movie]+=points
}}
previousMap=map
}catch{previousMap={}}
}

/* PROCESS */

function processData(data){
const movieMap={}
const maxPoints=data.success_cities*8

for(const city in data.rankings){
for(const key in data.rankings[city]){
const movie=data.rankings[city][key]
const rank=parseInt(key.replace("rank",""))
const points=9-rank

if(!movieMap[movie]){
movieMap[movie]={
name:movie,
points:0,
cities:new Set(),
rankDist:{1:0,2:0,3:0}
}
}

movieMap[movie].points+=points
movieMap[movie].cities.add(city)
if(rank<=3) movieMap[movie].rankDist[rank]++
}}

allMovies=Object.values(movieMap).map(m=>({
...m,
citiesCount:m.cities.size,
domination:(m.points/maxPoints)*100
}))

sortData()
}

/* RENDER */

function render(){

const tbody=document.getElementById("tbody")
tbody.innerHTML=""

let filtered=allMovies.filter(m=>
m.name.toLowerCase().includes(searchInput.value.toLowerCase())
)

if(filtered.length<=visibleCount) loadMoreBtn.style.display="none"
else loadMoreBtn.style.display="block"

filtered.slice(0,visibleCount).forEach((m,i)=>{

let prev=previousMap[m.name]||0
let diff=m.points-prev
let arrow=`<div class="flat">—</div>`
if(diff>0) arrow=`<div class="up">▲ +${diff}</div>`
if(diff<0) arrow=`<div class="down">▼ ${diff}</div>`

tbody.innerHTML+=`
<tr>
<td class="rank-col">${i+1}</td>
<td>${m.name}</td>
<td>${m.points}${arrow}</td>
<td>${m.citiesCount}</td>
<td>${m.rankDist[1]}</td>
<td>${m.rankDist[2]}</td>
<td>${m.rankDist[3]}</td>
<td>
<div class="impact-wrap">
<span>${m.domination.toFixed(2)}%</span>
<div class="impact-bar">
<div style="width:${m.domination}%"></div>
</div>
</div>
</td>
</tr>`
})
}

/* SORT */

function sortBy(field){
sortDirection=currentSort===field&&sortDirection==="desc"?"asc":"desc"
currentSort=field
sortData();render()
}

function sortData(){
allMovies.sort((a,b)=>{
let A=a[currentSort==="cities"?"citiesCount":currentSort]
let B=b[currentSort==="cities"?"citiesCount":currentSort]
return sortDirection==="asc"?A-B:B-A
})
}

function loadMore(){visibleCount+=30;render()}

/* COPY + TWEET */

function generateTweetText(){
let date=datePicker.value
let top10=allMovies.slice(0,10)
let text=`BMS Daily Hype - ${date}\n\n`
top10.forEach((m,i)=>{
text+=`${i+1}. #${m.name.replace(/\s+/g,"")} - ${m.points} | ${m.citiesCount} | ${m.domination.toFixed(2)}%\n`
})
return text
}

function copyTweet(){
navigator.clipboard.writeText(generateTweetText())
showToast("Copied to clipboard")
}

function tweetNow(){
window.open("https://twitter.com/intent/tweet?text="+encodeURIComponent(generateTweetText()))
}

/* TOAST */

function showToast(msg){
toast.innerText=msg
toast.classList.add("show")
setTimeout(()=>toast.classList.remove("show"),2000)
}

/* INIT */

searchInput.addEventListener("input",()=>{visibleCount=30;render()})

const today=new Date().toISOString().split("T")[0]
datePicker.value=today
datePicker.addEventListener("change",e=>{
visibleCount=30
loadData(e.target.value)
})

loadData(today)

</script>
</body>
</html>
